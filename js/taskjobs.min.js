function pin_agent(t){var e=t.chart_id,s=t.data[0],a=taskjobs.agents_chart[e];a.pinned_agents[s]=a.agents.toObject()[s],a.pinned_agents[s].logs={},taskjobs.refresh_pinned_agents(e)}function add_runlogs(t){return function(e,s,a){var n=taskjobs.agents_chart[t.chart_id],o=n.pinned_agents[t.agent_id];o&&(o.logs[t.i]=e,agents_dispatch.view(t.chart_id))}}function unpin_agent(t){var e=t.chart_id,s=t.data[0];delete taskjobs.agents_chart[e].pinned_agents[s],agents_dispatch.view(e)}function agent_is_pinned(t){var e=t.chart_id,s=t.data[0];return taskjobs.agents_chart[e].pinned_agents[s]}function agents_chart(t){function e(e){e.each(function(e,s){var a=d3.select(this).selectAll("div.agent_block").data(e);a.enter().append("div"),a.attr("class",function(e){var s=["agent_block"];agent_is_pinned({chart_id:t,data:e})&&s.push("pinned");e[1].length;return s.push("agent_"+e[1][0].state),s.join(" ")}).each(function(e){var s=d3.select(this).selectAll("a.link").data([e]);s.enter().append("a").attr("class","link btn").attr("href",e[1][0].link);var a=d3.select(this).selectAll("input").data([e]);a.enter().append("input").attr("type","checkbox").attr("class","check_restart").attr("value",e[0]).on("click",function(e){var s=taskjobs.agents_chart[t],a=e[1][0].agent_id;$(this).is(":checked")?s.checked_agents[a]=a:delete s.checked_agents[a],taskjobs.update_agents_view(t)});var n=d3.select(this).selectAll("a.name").data([e]);n.enter().append("a").attr("class","name").on("click",function(e){var s={chart_id:t,data:e};agent_is_pinned(s)?unpin_agent(s):pin_agent(s)}),n.exit().remove(),n.attr("href","javascript:void(0)").text(taskjobs.data.agents[e[0]]);var o=d3.select(this).selectAll("span.date").data([e]);o.enter().append("span").attr("class","date"),o.html([e[1][0].last_log_date].join("<br/>"));var r=d3.select(this).selectAll("span.comment").data([e]);if(r.enter().append("span").attr("class","comment"),r.text(function(t){return[t[1][0].last_log+" "].join(",")}),r.exit().remove(),"error"==e[1][0].state){d3.select(this).selectAll("a.restart").data([e]);n.enter().append("a").attr("class","restart btn").attr("title","restart").on("click",function(t){$.ajax({url:"../ajax/restart_job.php",data:{jobstate_id:t[1][0].jobstate_id,agent_id:t[1][0].agent_id},complete:function(){taskjobs.queue_refresh_logs(taskjobs.ajax_url,taskjobs.task_id)}})}),n.exit().remove(),n.attr("href","javascript:void(0)")}args={chart_id:t,data:e};var c=d3.select(this).selectAll("table.runs").data([agent_is_pinned(args)].filter(function(t){return!(!t||!t.logs)}));c.exit().remove(),c.enter().append("table").attr("class","runs"),c.each(function(t){var e=[];$.each(t.logs,function(t,s){e.push("<tr class='run header'><th colspan='3'>"+s.run+"</th></tr>"),$.each(s.logs,function(t,s){e.push("<tr class='run log'><td>"+s["log.date"]+"</td><td>"+taskjobs.logstatuses_names[s["log.state"]]+"</td><td class='comment'>"+s["log.comment"]+"</td></tr>")}),e.push("<tr class='run'><td class='void' colspan='4'></td></tr>")}),$(this).html(e.join("\n"))})}),a.exit().remove()})}var t=t;return e}var taskjobs={};taskjobs.show_form=function(t,e,s){$("#taskjobs_form").html(t)},taskjobs.hide_form=function(){$("#taskjobs_form").html("")},taskjobs.register_update_method=function(t){$("#"+t).off("change","*").on("change",function(t){$("#method_selected").text(t.val),taskjobs.hide_moduletypes_dropdown(),taskjobs.hide_moduleitems_dropdown(),taskjobs.clear_list("targets"),taskjobs.clear_list("actors")})},taskjobs.register_update_items=function(t,e,s){$("#"+t).off("change","*").on("change",function(t){taskjobs.show_moduleitems(s,e,t.val)})},taskjobs.register_form_changed=function(){$("form[name=form_taskjob]").off("change","*").on("change",function(t){$("#cancel_job_changes_button").show()})},taskjobs.create=function(t,e){$.ajax({url:t,data:{task_id:e},success:taskjobs.show_form})},taskjobs.edit=function(t,e){$.ajax({url:t,data:{id:e},success:taskjobs.show_form})},taskjobs.hide_moduletypes_dropdown=function(){$("#taskjob_moduletypes_dropdown").html("")},taskjobs.show_moduletypes_dropdown=function(t){$("#taskjob_moduletypes_dropdown").html(t)},taskjobs.hide_moduleitems_dropdown=function(){$("#taskjob_moduleitems_dropdown").html("")},taskjobs.show_moduleitems_dropdown=function(t){$("#taskjob_moduleitems_dropdown").html(t)},taskjobs.clear_list=function(t){$("#taskjob_"+t+"_list").html("")},taskjobs.delete_items_selected=function(t){$("#taskjob_"+t+"_list").find(".taskjob_item").has("input[type=checkbox]:checked").remove()},taskjobs.add_item=function(t,e,s,a){item_id=$("#"+a).val(),item_name=$("#taskjob_moduleitems_dropdown .select2-chosen").text(),item_id>0&&(item_to_add={id:e+"-"+item_id,name:item_name},item_exists=$("#taskjob_"+t+"_list").find("#"+item_to_add.id),0===item_exists.length?$("#taskjob_"+t+"_list").append("<div class='taskjob_item new' id='"+item_to_add.id+"'  >  <input type='checkbox'>  </input>  <span class='"+e+"'></span>  <label>     <span style='font-style:oblique'>"+s+"</span>     "+item_to_add.name+"  </label>  <input type='hidden' name='"+t+"[]' value='"+item_to_add.id+"'>  </input></div>"):item_exists.fadeOut(100).fadeIn(100))},taskjobs.show_moduletypes=function(t,e){taskjobs.hide_moduletypes_dropdown(),taskjobs.hide_moduleitems_dropdown(),$.ajax({url:t,data:{moduletype:e,method:$("#method_selected").text()},success:function(t,e,s){taskjobs.show_moduletypes_dropdown(t)}})},taskjobs.show_moduleitems=function(t,e,s){taskjobs.hide_moduleitems_dropdown(),$.ajax({url:t,data:{itemtype:s,moduletype:e,method:$("#method_selected").text()},success:function(t,e,s){taskjobs.show_moduleitems_dropdown(t)}})},taskjobs.Queue=$({refresh:0,timer:null}),taskjobs.unfolds={targets:{},agents:{},executions:{}};var agents_dispatch=d3.dispatch("view");taskjobs.refresh_pinned_agents=function(t){var e=taskjobs.agents_chart[t];$.each(e.pinned_agents,function(e,s){if(s){var a=Math.min(s.length,taskjobs.includeoldjobs);for(a==-1&&(a=s.length),i=0;i<a&&!(i>0&&s.length>1&&s[i].jobstate_id==s[i-1].jobstate_id);i++)$.ajax({url:"../ajax/jobstates_logs.php",data:{id:s[i].jobstate_id,last_date:s[i].last_log_date},success:add_runlogs({i:i,agent_id:e,chart_id:t})})}})},taskjobs.update_agents_view=function(t){if(taskjobs.agents_chart[t]){var e=taskjobs.agents_chart[t],s=Lazy([]),a=e.agents.toObject();Lazy(Object.keys(e.pinned_agents)).each(function(t){var s=e.pinned_agents[t].logs;e.pinned_agents[t]=a[t],e.pinned_agents[t].logs=s}),pinned_agents=Lazy(e.pinned_agents),Lazy(Object.keys(e.type_selected)).each(function(t){s=s.union(e.counters[t])}),s=s.map(function(t){return[t,!0]}).toObject();var n=e.agents.reject(function(t){return!!e.pinned_agents[t[0]]||!s[t[0]]}),o=Lazy(pinned_agents.toArray()).concat(n.toArray()).first(e.view_limit);taskjobs.agents_chart[t].filtered_agents=s,taskjobs.agents_chart[t].agents_to_view=o.toArray(),taskjobs.agents_chart[t].total_agents_to_view=n.size()+pinned_agents.size(),taskjobs.agents_chart[t].debug=n}taskjobs.agents_chart[t].display_agents=!0},taskjobs.display_agents_view=function(t){if(taskjobs.agents_chart[t].display_agents){var e=taskjobs.agents_chart[t],s=e.agents_to_view;d3.select(e.selector).datum(s).call(agents_chart(t));var a=e.total_agents_to_view-s.length;a<=0&&(taskjobs.agents_chart[t].view_limit=10);var n=10,o=[];n=a>0?Math.min(a,10):0,o=[{text:"Show "+n+" more ("+a+" left)",limit:n}];var r=$(e.selector).parent()[0],c=d3.select(r).selectAll("div.show_more").selectAll("input.restart").data(o);c.enter().append("input"),c.exit().remove(),c.attr("type","button").attr("class","submit restart").attr("value","Restart selected jobs").style("display",function(t){return Object.keys(e.checked_agents).length>0?null:"none"}).on("click",function(t){$(".refresh_button > span").addClass("fetching");var s=[];$("input.check_restart:checked").each(function(t){var a=$(this).parent().index(),n=e.agents.toArray();s.push({agent_id:n[a][1][0].agent_id,jobstate_id:n[a][1][0].jobstate_id})}),$.ajax({url:"../ajax/restart_job.php",method:"post",data:{params:s},complete:function(){taskjobs.queue_refresh_logs(taskjobs.ajax_url,taskjobs.task_id),$("input.check_restart:checked").each(function(){$(this).attr("checked",!1)}),$(".refresh_button > span").removeClass("fetching")}})});var i=d3.select(r).selectAll("div.show_more").selectAll("input.more_button").data(o);i.enter().append("input").attr("type","button").attr("class","submit more_button").on("click",function(e){taskjobs.agents_chart[t].view_limit+=e.limit,taskjobs.update_agents_view(t)}),i.exit().remove(),i.style("display",function(t){return a>0?null:"none"}).attr("disabled",function(t){return t.limit>0?null:"disabled"}).attr("value",function(t){return t.text});var _=d3.select(r).selectAll("div.show_more").selectAll("input.reset_button").data(o);_.enter().append("input").attr("type","button").attr("class","submit reset_button").on("click",function(e){taskjobs.agents_chart[t].view_limit=10,taskjobs.update_agents_view(t)}),_.exit().remove(),_.style("display",function(t){return s.length>10?null:"none"}).attr("value","Reset view"),taskjobs.agents_chart[t].display_agents=!1}},agents_dispatch.on("view",function(t){taskjobs.update_agents_view(t)}),taskjobs.toggle_details_type=function(t,e,s){view=!1,t._view&&(view=t._view),t._view=!view,t._view?taskjobs.agents_chart[s].type_selected[e]=!0:delete taskjobs.agents_chart[s].type_selected[e],$(t).toggleClass("expanded",t.view),agents_dispatch.view(s)},taskjobs.create_block=function(t,e,s){element=$(t),0===element.length?$(e).append($(s)):($(t).remove(),$(e).append($(s)))};var templates={},targets_cpt=0;taskjobs.init_templates=function(){templates={task:$("#template_task").html(),job:$("#template_job").html(),target:$("#template_target").html(),target_name:$("#template_target_name").html(),target_stats:$("#template_target_stats").html(),counter_block:$("#template_counter_block").html(),counter_content:$("#template_counter_content").html(),agent:$("#template_agent").html()},Lazy(templates).each(function(t){Mustache.parse(t)})},taskjobs.charts={},taskjobs.agents_chart={},taskjobs.update_logs=function(t){taskjobs.data=$.parseJSON(t),taskjobs.compute_data(),blocks_seen={tasks:[],jobs:[],targets:[],charts:[],agents_chart:[]},tasks=taskjobs.data.tasks,tasks_selector=".tasks_block",$.each(tasks,function(t,e){task_id="task_"+e.task_id,task_name=e.task_name,task_selector="#"+task_id,blocks_seen.tasks.push(task_selector),taskjobs.create_block(task_selector,tasks_selector,Mustache.render(templates.task,{task_id:task_id,task_name:task_name,expanded:"true"==e.expanded?"expand":""})),jobs_selector=task_selector+" .jobs_block",$.each(e.jobs,function(t,e){job_id=e.id,job_name=e.name,job_selector="#job_"+job_id,blocks_seen.jobs.push(job_selector),taskjobs.create_block(job_selector,jobs_selector,Mustache.render(templates.job,{job_id:"job_"+job_id,job_name:job_name})),targets_selector=job_selector+" .targets_block",$.each(e.targets,function(t,s){target_id=t+"_"+targets_cpt,targets_cpt++,target_name=s.name,target_link=s.item_link,target_selector=task_selector+" #"+target_id,blocks_seen.targets.push(target_selector);var a="job_"+e.id+"_"+target_id;taskjobs.create_block(target_selector,targets_selector,Mustache.render(templates.target,{target_id:target_id,target_link:target_link,target_name:target_name})),agents_selector=target_selector+" .agents_block";var n=null;n=Object.keys(s.agents).length>0?s.agents:Lazy(new Object),taskjobs.agents_chart[a]||(taskjobs.agents_chart[a]={selector:agents_selector,type_selected:{},pinned_agents:{},checked_agents:{},view_limit:10},d3.timer(function(){taskjobs.display_agents_view(a)},1e3)),taskjobs.agents_chart[a].agents=n,taskjobs.agents_chart[a].counters=s.counters_computed,taskjobs.refresh_pinned_agents(a),agents_dispatch.view(a),counters_selector=target_selector+" .target_stats",$.each(taskjobs.statuses_order,function(t,e){stats_type_selector=target_selector+" ."+t,taskjobs.create_block(stats_type_selector,counters_selector,Mustache.render(templates.target_stats,{stats_type:t})),$.each(e,function(t,e){counter_value=s.counters_computed[e],counter_type=e,counter_empty=0===counter_value.length,counter_type_name=taskjobs.statuses_names[counter_type],counter_selector=target_selector+" ."+counter_type,taskjobs.create_block(counter_selector,stats_type_selector,Mustache.render(templates.counter_block,{counter_empty:counter_empty,counter_type:counter_type,chart_id:a,counter_type_name:counter_type_name,counter_value:counter_value.length}))})});var o=[target_selector,".target_details","div.progressbar"].join(" > ");blocks_seen.charts.push("#chart_"+a),0===$("#chart_"+a).length&&(taskjobs.charts[a]=taskjobs.create_progressbar(o,"chart_"+a,400,100),taskjobs.charts[a].new_data=[0,0,0],taskjobs.update_progressbar(taskjobs.charts[a])),taskjobs.charts[a].new_data=[s.counters_computed.agents_success.length,s.counters_computed.agents_error.length,s.counters_computed.agents_notdone.length],!d3.sum(taskjobs.charts[a].new_data)>0?$(o).addClass("empty"):$(o).removeClass("empty"),$(counters_selector).show(),$(target_selector).show()}),$(job_selector).show()}),$(task_selector).show()}),$(".refresh_button span").removeClass("computing"),taskjobs.blocks_seen&&(cache=taskjobs.blocks_seen,node_to_drop=Lazy([]).concat(Lazy(cache.tasks).without(blocks_seen.tasks).toArray()).concat(Lazy(cache.jobs).without(blocks_seen.jobs).toArray()).concat(Lazy(cache.targets).without(blocks_seen.targets).toArray()).concat(Lazy(cache.charts).without(blocks_seen.charts).toArray()),$.each(node_to_drop.toArray(),function(t,e){$(e).remove()})),$(Object.keys(taskjobs.charts)).delay(500).each(function(t,e){taskjobs.update_progressbar(taskjobs.charts[e])}),taskjobs.blocks_seen=blocks_seen,taskjobs.init_tasks_expand_buttons()},taskjobs.compute_data=function(){tasks=taskjobs.data.tasks,result=[],$.each(tasks,function(t,e){task=tasks[t],$.each(task.jobs,function(t,e){job=task.jobs[t],$.each(job.targets,function(t,e){e.counters_computed={agents_prepared:Object.keys(e.counters.agents_prepared),agents_running:Object.keys(e.counters.agents_running),agents_cancelled:Object.keys(e.counters.agents_cancelled),agents_notdone:Object.keys(e.counters.agents_notdone),agents_error:Object.keys(e.counters.agents_error),agents_success:Object.keys(e.counters.agents_success)},Object.keys(e.agents).length>0&&(e.agents=Lazy(e.agents).sortBy(function(t){return t[1][0].timestamp}).reverse()),counters=e.counters_computed,counters.agents_notdone=Lazy(counters.agents_notdone).toArray(),counters.agents_total=Lazy(counters.agents_success).union(counters.agents_error).toArray()})})})},taskjobs.create_progressbar=function(t,e,s,a){var n=d3.select(t).append("svg").attr("id",e).attr("class","chart").attr("width",s).attr("height",a);return origin=n.append("g").attr("transform","translate("+s/2+","+a+")"),origin.append("g").attr("class","arcs"),origin.append("g").attr("class","pointers"),origin.append("g").attr("class","texts"),n._width=s,n},taskjobs.update_progressbar=function(e){var s=e.new_data;remapped=[];var a=0,n=d3.sum(s),o=Math.PI;n>0?(s.forEach(function(e,s){t=Math.ceil(e/n*16),remapped.push({real:e,value:t.toFixed(0),index:s,x0:a,x1:a+=+t})}),e.style("display","")):e.style("display","none");var r=80,c=d3.scale.linear().domain([0,n]).range([0,100]),_=d3.scale.ordinal().domain([0,1,2]).range(["#8F8","#F33","#ccc"]),l=(d3.scale.ordinal().domain([0,1,2]).range(["#0A0","#A00","#777"]),d3.format(".1s"),d3.layout.pie().value(function(t,e){return n>0?t.value:3==e?100:void 0}).sort(null).startAngle(-90*(o/180)).endAngle(90*(o/180))),d=d3.svg.arc().innerRadius(r-25).outerRadius(r),u=e.select("g.arcs").selectAll("path.arc").data(l(remapped));u.enter().append("path").attr("class","arc").attr("fill",function(t,e){return _(e)}).each(function(t){this._current=t});d3.dispatch("newangle");arcTween=function(t){var e=d3.interpolate(this._current,t);return this._current=e(0),function(t){return i=e(t),d(e(t))}},u.transition().duration(500).attrTween("d",arcTween),u.exit().remove(),cursorposTween=function(t){var e=d3.interpolate(this._current,t);return this._current=e(0),function(t){return"translate("+d.centroid(e(t))+")"}};var p=e.select("g.texts").selectAll("text").data(l(remapped));p.enter().append("text").attr("text-anchor","middle").attr("font-size","0.5em").each(function(t){this._current=t}),p.text(function(t){return c(t.data.real).toFixed(1)}),p.attr("display",function(t){return t.data.value>0?"":"none"}),p.transition().duration(500).attrTween("transform",cursorposTween),p.exit().remove()},taskjobs.get_logs=function(t,e){$(".refresh_button > span").addClass("fetching").removeClass("computing");var s={task_id:e,includeoldjobs:taskjobs.includeoldjobs,refresh:taskjobs.refresh};$.ajax({url:t,data:s,success:function(t,e,s){$(".refresh_button > span").addClass("computing").removeClass("fetching"),setTimeout(function(){taskjobs.update_logs(t)},50)},complete:function(){taskjobs.update_refresh_buttons(t,e),taskjobs.Queue.queue("refresh_logs").pop()}})},taskjobs.update_refresh_buttons=function(t,e){$(".refresh_button").off("click").on("click",function(s){taskjobs.queue_refresh_logs(t,e)})},taskjobs.init_include_old_jobs_buttons=function(t,e,s){$("#"+s).off("click").on("change",function(s){taskjobs.includeoldjobs=$(this).val(),taskjobs.queue_refresh_logs(t,e)})},taskjobs.init_tasks_expand_buttons=function(){$(".monitoring-logs .task_block > h3").off("click").on("click",function(t){$(this).parent().toggleClass("expand");var e=$(this).parent().attr("id"),s=e.replace("task_","");$.ajax({url:"../ajax/expand_task.php",data:{task_id:s,expanded:$(this).parent().hasClass("expand")}})})},taskjobs.init_refresh_form=function(t,e,s){$("#"+s).off("change").on("change",function(){taskjobs.update_logs_timeout(t,e,s)})},taskjobs.update_logs_timeout=function(t,e,s){taskjobs.refresh=$("#"+s).val(),window.clearTimeout(taskjobs.Queue.timer),taskjobs.queue_refresh_logs(t,e),"off"!=taskjobs.refresh?(taskjobs.Queue.refresh=1e3*taskjobs.refresh,taskjobs.Queue.timer=window.setInterval(function(){taskjobs.queue_refresh_logs(t,e)},taskjobs.Queue.refresh)):window.clearTimeout(taskjobs.Queue.timer)},taskjobs.queue_refresh_logs=function(t,e){var s=taskjobs.Queue.queue("refresh_logs");$(".tasks_block:hidden").remove(),0===$(".tasks_block:visible").length&&window.clearTimeout(taskjobs.Queue.timer),0===s.length&&(taskjobs.Queue.queue("refresh_logs",function(){taskjobs.get_logs(t,e)}),taskjobs.Queue.queue("refresh_logs")[0]())};var expandtaskjobform=function(){$("#taskjobdisplay").css("overflow","visible").css("height","auto"),$("#seemore").css("display","none")};$(document).ready(function(){$(document).on("click",".toggle_details_type",function(t){taskjobs.toggle_details_type($(this)[0],$(this).attr("data-counter_type"),$(this).attr("data-chart_id"))}),$(document).on("click",".clear_list",function(t){taskjobs.clear_list($(this).attr("data-clear-param"))}),$(document).on("click",".delete_items_selected",function(t){taskjobs.delete_items_selected($(this).attr("data-delete-param"))}),$(document).on("click","#add_fusinv_job_item_button",function(t){taskjobs.add_item($(this).attr("data-moduletype"),$(this).attr("data-itemtype"),$(this).attr("data-itemtype_name"),$(this).attr("data-dropdown_rand_id"))}),$(document).on("click",".show_moduletypes",function(t){taskjobs.show_moduletypes($(this).attr("data-ajaxurl"),$(this).attr("data-itemtype"),$(this).attr("data-method"))}),$(document).on("click",".taskjobs_create",function(t){taskjobs.create($(this).attr("data-ajaxurl"),$(this).attr("data-task_id"))}),$(document).on("click",".taskjobs_edit",function(t){taskjobs.edit($(this).attr("data-ajaxurl"),$(this).attr("data-taskjob_id"))}),$(document).on("click",".openExportDialog",function(t){$("#fiTaskExport_modalWindow").dialog({modal:!0,resizeable:!0,height:200,width:480})}),$(document).on("click",".task_export_form .submit",function(t){$("#fiTaskExport_modalWindow").dialog("close")})});